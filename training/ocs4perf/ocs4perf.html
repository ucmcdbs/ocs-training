<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Testing your OpenShift Container Storage deployment :: OCS Training</title>
    <link rel="canonical" href="https://red-hat-storage.github.io/ocs-training/training/ocs4perf/ocs4perf.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LGCEEZGN54"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-LGCEEZGN54')</script>
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="40px" alt="Red Hat Data Services">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage" target="_blank">OCS Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/blob/master/CONTRIBUTING.adoc" target="_blank">Guidelines</a>
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">OCS Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OCS Installation and Configuration</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4/ocs.html">General deploy and use</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4/ocs4-install-no-ui.html">CLI based install</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4/ocs4-install-no-ui-1scale.html">Single node scaling support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../RegionalDR/manual/ocs4-multisite-replication.html">Regional disaster recovery (manual method)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../RegionalDR/helper/requirements.html">Regional disaster recovery (RDRhelper)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4/ocs4-metro-stretched.html">Metro disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4/ocs4-encryption.html">External KMS Encryption</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4/ocs4-cluster-downsize.html">Downsize existing OCS cluster</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4/ocs4-enable-rgw.html">Use RGW in OCS deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../infra-nodes/ocs4-infra-nodes.html">Deploying on Infra nodes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="ocs4perf.html">Test deployment post-install</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OCS Installation and Configuration</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OCS Installation and Configuration</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../RegionalDR/index.html">ODF Regional DR</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../RegionalDR/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OCS Installation and Configuration</a></li>
    <li><a href="ocs4perf.html">Test deployment post-install</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/red-hat-storage/ocs-training/edit/master/training/modules/ocs4perf/pages/ocs4perf.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Testing your OpenShift Container Storage deployment</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Customers and Partners need a testing tool to validate OpenShift Container
Storage performance offered by the cluster for each storage class created
during the deployment.</p>
</div>
<div class="paragraph">
<p>Using basic commands for benchmarking, such as the <code>dd</code> command, are not
representative of modern multi-threaded workloads. Likewise, using
single-threading commands, such as <code>dd</code>, for IO benchmarking are unable
to illustrate OCS/Ceph performance. The <code>dd</code> command suffers from being
a purely sequential IO and single-threaded tool causing <code>dd</code> to only communicate
with a single OSD at a time for each 4MB sequence it reads or writes when using
IO flags such as <code>O_DSYNC</code>, <code>O_SYNC</code> or <code>O_DIRECT</code>.</p>
</div>
<div class="paragraph">
<p>Given these limitations, it is necessary to make a tool available
to easily perform a functional test of OpenShift Container Storage
(provision a volume, attach a volume, read or write from or to a volume,
detach the volume, delete the volume) while also allowing to get a better
view of the level of performance offered by the storage backend through the
use of a multi-threaded tool that can leverage all the OSDs within
the Ceph cluster during the test sequence.</p>
</div>
<div class="paragraph">
<p>The <code>sysbench</code> tool offers multiple testing capabilities
(CPU, Mutex, file, mysql) allowing for this testing tool to be
expanded over time while having sequential and random IO capabilities as well
as single and multi threading capabilities. It is also a tool actively maintained
on github (<code><a href="https://github.com/akopytov/sysbench" class="bare">https://github.com/akopytov/sysbench</a></code>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_your_custom_container_image_disconnected_environments"><a class="anchor" href="#_building_your_custom_container_image_disconnected_environments"></a>2. Building your custom container image (disconnected environments)</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker build -t sysbench:latest .
docker tag sysbench:latest {use_your_preferred_registry}/sysbench:latest
docker push {use_your_preferred_registry}/sysbench:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have made publicly available the container image at
<code>quay.io/vcppds7878/sysbench:latest</code> for convenience if you
have Internet access from your OCP cluster.</p>
</div>
<div class="paragraph">
<p>All the pre-populated testing scripts have been configured the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1 - Prepare the test files in an asynchornous way</p>
<div class="ulist">
<ul>
<li>
<p>Data sample is 4096MB spread over 128 files for 4KB and 4MB testing</p>
</li>
<li>
<p>Data sample is 4096MB spread over 2 files for 1GB testing</p>
</li>
</ul>
</div>
</li>
<li>
<p>Step 2 - IO test run</p>
<div class="ulist">
<ul>
<li>
<p>All IO testing use <code>O_DSYNC</code> flag in synchronous mode</p>
</li>
<li>
<p>All IO size are set to 4KB, 4MB or 1GB</p>
</li>
<li>
<p>All IO tests use 16 threads except the 1GB sequential using only 2</p>
</li>
<li>
<p>All IO tests will run for 30 seconds</p>
</li>
</ul>
</div>
</li>
<li>
<p>Step 3 - Cleanup the test files in an asynchornous way</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_default_configuration_internal_cluster"><a class="anchor" href="#_default_configuration_internal_cluster"></a>2.1. Default Configuration (Internal cluster)</h3>
<div class="paragraph">
<p>All yaml files below are configured with the storage class names of an
internal cluster and for pulling the container image from the public
location mentioned above. Each yaml file also creates by default a project
named <code>sysbench</code>.</p>
</div>
<div class="paragraph">
<p>Each pod is allocated a 5GB PVC execpt the IDLE pod that is allocated a 10GB one.</p>
</div>
</div>
<div class="sect2">
<h3 id="_external_cluster_configuration"><a class="anchor" href="#_external_cluster_configuration"></a>2.2. External Cluster Configuration</h3>
<div class="paragraph">
<p>To switch the yaml files when testing against an external cluster run the
following commands in the directory containing your yaml files.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># for f in $(ls *.yaml); do sed -i -e 's/ocs-storagecluster/ocs-external-storagecluster/g' $f; done</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_disconnected_environments"><a class="anchor" href="#_disconnected_environments"></a>2.3. Disconnected Environments</h3>
<div class="paragraph">
<p>You might require to update the yaml files provided with a SHA based reference when operating
in a disconnected environment. To do so run the following command.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># docker pull quay.io/vcppds7878/sysbench:v1.0
# for f in $(ls *.yaml); do sed -i -e "s#sysbench:latest#sysbench@sha256:$(docker inspect quay.io/vcppds7878/sysbench:v1.0|jq -r '.[].RepoDigests[0]'|cut -f2 -d:)#g" $f; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Need be replace the <code>docker</code> command with the <code>podman</code> command.</p>
</div>
<div class="paragraph">
<p>The current version of the tool matches the following characteristics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>v1.0: sha256:1009aacf752870bd38bda64d5c372fa7f370d225532560799a484a18a52ddea1</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_custom_build_environments"><a class="anchor" href="#_custom_build_environments"></a>2.4. Custom Build Environments</h3>
<div class="paragraph">
<p>Same <code>bash</code> <code>for</code> loop can be used to update your container image reference.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_idle_test_box"><a class="anchor" href="#_idle_test_box"></a>3. IDLE Test Box</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>RWO PVC (run your own commands)</p>
<div class="ulist">
<ul>
<li>
<p><code>oc create -f sysbench-rwo-idle.yaml</code></p>
</li>
<li>
<p><code>oc delete -f sysbench-rwo-idle.yaml</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>RWX PVC (run your own commands)</p>
<div class="ulist">
<ul>
<li>
<p><code>oc create -f sysbench-rwx-idle.yaml</code></p>
</li>
<li>
<p><code>oc delete -f sysbench-rwx-idle.yaml</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preconfigured_test_box"><a class="anchor" href="#_preconfigured_test_box"></a>4. Preconfigured Test Box</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Write Mode</p>
<div class="ulist">
<ul>
<li>
<p><code>oc create -f sysbench-[rwo|rwx]-[r|s]write-[4k|4m|1g].yaml</code></p>
</li>
<li>
<p><code>oc delete -f sysbench-[rwo|rwx]-[r|s]write-[4k|4m|1g].yaml</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Read/Write Mode</p>
<div class="ulist">
<ul>
<li>
<p><code>oc create -f sysbench-[rwo|rwx]-[r|s]readwrite-[4k|4m|1g].yaml</code></p>
</li>
<li>
<p><code>oc delete -f sysbench-[rwo|rwx]-[r|s]readwrite-[4k|4m|1g].yaml</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Read Mode</p>
<div class="ulist">
<ul>
<li>
<p><code>oc create -f sysbench-[rwo|rwx]-[r|s]read-[4k|4m|1g].yaml</code></p>
</li>
<li>
<p><code>oc delete -f sysbench-[rwo|rwx]-[r|s]read-[4k|4m|1g].yaml</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If using your own container image make sure to update the <code>docker tag</code>
and <code>docker push</code> commands with the appropriate references as well as the
YAML files provided.</p>
</div>
<div class="paragraph">
<p>You can choose the following predefined options built-in the file name:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PVC type</p>
<div class="ulist">
<ul>
<li>
<p>Choose between <code>rwo</code> (RBD based) or <code>rwx</code> (CephFS based)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Workload type</p>
<div class="ulist">
<ul>
<li>
<p>Choose between <code>r</code> (random) or <code>s</code> (sequential) workload type</p>
</li>
</ul>
</div>
</li>
<li>
<p>IO size</p>
<div class="ulist">
<ul>
<li>
<p>Choose between <code>4k</code> (4KB), <code>4m</code> (4MB) or <code>1g</code> (1GB)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_example_output"><a class="anchor" href="#_example_output"></a>5. Example Output</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start a random write test. The default is to run the test with 16 threads
with a 4KB block size. If you are looking for a more customizable experience
use the <code>sysbench-rwo-idle.yaml</code> or sysbench-rwx-idle.yaml file. Once the
pod starts you will have 20 minutes to connect into the pod  via <code>oc rsh</code>
and perform any test you see fit.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># oc create -f sysbench-rwo-rwrite-4k.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre>namespace/sysbench created
persistentvolumeclaim/pvc-sysbenchrbd-write created
job.batch/sysbench-file-write created</pre>
</div>
</div>
<div class="paragraph">
<p>Verify the storage was allocated and bound to the pod.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># oc get pvc -n sysbench</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre>NAME                    STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS                              AGE
pvc-sysbenchrbd-write   Bound    pvc-00cfa5ac-2356-4ae8-8b39-cd2b77bdf3f4   1Gi        RWO            ocs-independent-storagecluster-ceph-rbd   13s</pre>
</div>
</div>
<div class="paragraph">
<p>Now wait for the pod to complete. All results will be displayed in the pod log.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># oc get pods -n sysbench -w</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre>NAME                        READY   STATUS              RESTARTS   AGE
sysbench-file-write-m6mnd   0/1     ContainerCreating   0          26s
sysbench-file-write-m6mnd   1/1     Running             0          27s
sysbench-file-write-m6mnd   0/1     Completed           0          41s</pre>
</div>
</div>
<div class="paragraph">
<p>Now inspect the test results.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># oc logs $(oc get pods -o name -n sysbench) -n sysbench</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre>Currently mounted filesystems for Random WRITE test
/dev/rbd0                               999320     2564    980372   1% /tmp/data
Changing working directory to /tmp/data
Current working directory for control before execution
/tmp/data
+ sysbench --threads=16 --test=fileio --file-total-size=128m --file-test-mode=rndwr --file-block-size=4k --file-io-mode=async --file-fsync-freq=0 prepare
WARNING: the --test option is deprecated. You can pass a script name or path on the command line without any options.
sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)

128 files, 1024Kb each, 128Mb total
Creating files for the test...
Extra file open flags: (none)
Creating file test_file.0
Creating file test_file.1
[... truncated ...]
Creating file test_file.126
Creating file test_file.127
134217728 bytes written in 3.41 seconds (37.51 MiB/sec).
+ set +x
+ sysbench --threads=16 --test=fileio --file-total-size=128m --file-test-mode=rndwr --file-block-size=4k --file-extra-flags=dsync run
WARNING: the --test option is deprecated. You can pass a script name or path on the command line without any options.
sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)

Running the test with following options:
Number of threads: 16
Initializing random number generator from current time


Extra file open flags: dsync
128 files, 1MiB each
128MiB total file size
Block size 4KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random write test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      0.00
    writes/s:                     8466.75
    fsyncs/s:                     11034.61

Throughput:
    read, MiB/s:                  0.00
    written, MiB/s:               33.07

General statistics:
    total time:                          10.0060s
    total number of events:              193174

Latency (ms):
         min:                                    0.00
         avg:                                    0.82
         max:                                   13.63
         95th percentile:                        2.97
         sum:                               158721.54

Threads fairness:
    events (avg/stddev):           12073.3750/109.77
    execution time (avg/stddev):   9.9201/0.00

+ sysbench --threads=16 --test=fileio --file-total-size=128m --file-test-mode=rndwr --file-block-size=4k --file-io-mode=async --file-fsync-freq=0 cleanup
WARNING: the --test option is deprecated. You can pass a script name or path on the command line without any options.
sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)

Removing test files...
+ set +x
Changing working directory to /</pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Red Hat Data Services">
  </a>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
